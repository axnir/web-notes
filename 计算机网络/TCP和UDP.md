#  TCP 和 UDP

### TCP

> `TCP`（Transmission Control Protocol，传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。

`TCP` 相对于 `UDP` 有 2 个特点：

- 对于数据包的丢失，建立重传机制
- `TCP` 引入数据包排序机制，用来保证把乱序的数据包组合成一个完整的文件

##### 三次握手过程

> 所谓三次握手(Three-way Handshake)，是指建立一个 TCP 连接时，需要客户端和服务器总共发送3个包。
>
> 三次握手的目的是连接服务器指定端口，建立 TCP 连接，并同步连接双方的序列号和确认号，交换 TCP 窗口大小信息。在 socket 编程中，客户端执行 `connect()` 时。将触发三次握手。

刚开始客户端处于 `Closed` 的状态，服务器处于 `Listen` 状态。

1. 第一次握手(SYN=1, seq=x)

   客户端发送一个 TCP 的 SYN 标志位置1的包，指明客户端打算连接的服务器的端口，以及初始序号 X,保存在包头的序列号(Sequence Number)字段里。

   发送完毕后，客户端进入 `SYN_SENT` 状态。

2. 第二次握手(SYN=1, ACK=1, seq=y, ACKnum=x+1)

   服务器发回确认包(ACK)应答。即 SYN 标志位和 ACK 标志位均为1。服务器端选择自己 ISN 序列号，放到 Seq 域里，同时将确认序号(Acknowledgement Number)设置为客户的 ISN 加1，即X+1。 

   发送完毕后，服务器端进入 `SYN_RCVD` 状态。

3. 第三次握手(ACK=1, seq = x+1, ACKnum=y+1)

   客户端再次发送确认包(ACK)，SYN 标志位为0，ACK 标志位为1，并且把服务器发来 ACK 的序号字段+1，放在确定字段中发送给对方，并且在数据段放写ISN的+1

   发送完毕后，客户端进入 `ESTABLISHED` 状态，当服务器端接收到这个包时，也进入 `ESTABLISHED` 状态，TCP 握手结束。

###### 三次握手示意图
<img src="..\pics\TCP三次握手.png" alt="TCP 三次握手" style="zoom:80%;" />

##### 四次挥手过程

> TCP 的连接的拆除需要发送四个包，因此称为四次挥手(Four-way handshake)，也叫做改进的三次握手。客户端或服务器均可主动发起挥手动作，在 socket 编程中，任何一方执行 `close()` 操作即可产生挥手操作。

刚开始客户端和服务器都处于 `ESTABLISHED` 的状态。

- 第一次挥手(FIN=1，seq=u)

  假设客户端想要关闭连接，客户端发送一个 FIN 标志位置为1的包，表示自己已经没有数据可以发送了，但是仍然可以接受数据。

  发送完毕后，客户端进入 `FIN_WAIT_1` 状态。

- 第二次挥手(ACK=1，seq=v，ACKnum=u+1)

  服务器端确认客户端的 FIN 包，发送一个确认包，表明自己接受到了客户端关闭连接的请求，但还没有准备好关闭连接。

  发送完毕后，服务器端进入 `CLOSE_WAIT` 状态，客户端接收到这个确认包之后，进入 `FIN_WAIT_2` 状态，等待服务器端关闭连接。

- 第三次挥手(FIN=1，ACK=1，seq=w，ACKnum=u+1)

  服务器端准备好关闭连接时，向客户端发送结束连接请求，FIN 置为1。

  发送完毕后，服务器端进入 `LAST_ACK` 状态，等待来自客户端的最后一个ACK。

- 第四次挥手(ACK=1，seq=u+1，ACKnum=w+1)

  客户端接收到来自服务器端的关闭请求，发送一个确认包，并进入 `TIME_WAIT`状态，等待可能出现的要求重传的 ACK 包。

  服务器端接收到这个确认包之后，关闭连接，进入 `CLOSED` 状态。

  客户端等待了某个固定时间（两个最大段生命周期，2MSL，2 Maximum Segment Lifetime）之后，没有收到服务器端的 ACK ，认为服务器端已经正常关闭连接，于是自己也关闭连接，进入 `CLOSED` 状态。

###### 四次挥手示意图

<img src="..\pics\TCP四次挥手.png" alt="TCP四次挥手" style="zoom:80%;" />



##### TCP 对应的协议

1. **FTP**：定义了文件传输协议，数据使用20端口，控制使用21端口。
2. **Telnet**：一种用于远程登陆的端口，使用23端口，用户可以以自己的身份远程连接到计算机上，可提供基于DOS模式下的通信服务。
3. **SMTP**：邮件传送协议，用于发送邮件。服务器开放的是25号端口。
4. **POP3**：它是和SMTP对应，POP3用于接收邮件。POP3协议所用的是110端口。
5. **HTTP**：是从Web服务器传输超文本到本地浏览器的传送协议。默认端口80。

### UDP

> 用户数据包协议（User Datagram Protocol），简称 `UDP`，是基于 `IP` 之上开发能和应用打交道的协议。
>

`UDP` 中一个最重要的信息是端口号，端口号其实就是一个数字，每个想访问网络的程序都需要绑定一个端口号。

通过端口号 `UDP` 就能把指定的数据包发送给指定的程序了，所以通过 `IP` 地址信息把数据包发送给指定的电脑，而 `UDP` 通过端口号把数据包分发给正确的程序。

`UDP` 传输缺陷：

- 数据包在传输过程容易丢失
- 大文件传输中，`UDP` 并不知道如何组成这些数据包，不知道如何还原成完整的文件。

虽说 `UDP` 不能保证数据可靠性，但是传输速度却非常快，所以 `UDP` 会应用在一些关注速度、但不那么严格要求数据完整性的领域，如在线视频、互动游戏等。

##### UDP 对应的协议

1. **DNS**：用于域名解析服务，将域名地址转换为IP地址。DNS用的是53号端口。
2. **SNMP**：简单网络管理协议，使用161号端口，是用来管理网络设备的。由于网络设备很多，无连接的服务就体现出其优势。
3. **TFTP**(Trival File Transfer Protocal)：简单文件传输协议，该协议在熟知端口69上使用UDP服务。
4. **DHCP**(Dynamic Host Configuration Protocol)：动态主机配置协议是一个局域网的网络协议， 主要有两个用途：给内部网络或网络服务供应商自动分配IP地址，给用户或者内部网络管理员作为对所有计算机作中央管理的手段。



###  TCP 和 UDP 区别

- `TCP` 是面向连接的，`UDP` 是无连接的即发送数据前不需要先建立链接。
- `TCP` 提供可靠的服务。也就是说，通过 `TCP` 连接传送的数据，无差错，不丢失，不重复，且按序到达；UDP尽最大努力交付，即不保证可靠交付。并且因为 `TCP` 可靠，面向连接，不会丢失数据因此适合大数据量的交换。
- `TCP` 是面向字节流，`UDP` 面向报文，并且网络出现拥塞不会使得发送速率降低（因此会出现丢包，对实时的应用比如 `IP` 电话和视频会议等）。
- `TCP` 只能是 1对1 的，`UDP` 支持 1对1、1对多、多对多。
- `TCP` 的首部较大为 `20` 字节，而 `UDP` 只有 `8` 字节。